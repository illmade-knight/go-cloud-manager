# **Prompt 05: IAM Logic (Planner & Manager)**

**Objective:** Generate the core logic for the iam package. This includes the RolePlanner responsible for translating the high-level architecture into a concrete IAM plan, and the IAMManager that orchestrates the application of that plan.

## **Primary Prompt (Concise)**

Your task is to generate the Go code for the iam/iammanager.go file.

You must implement the IAMManager which takes the plan generated by the RolePlanner, groups the permissions by resource, and uses the IAMClient interface to apply the final, atomic policies to each resource.

**Key Requirements to Fulfill:**

* **L1-2.2 (Identity and Access Management):** The manager orchestrates the application of the IAM plan.
* **L2-1.1 (Modularity & Separation of Concerns):** The manager's role is orchestration, separating it from the planning logic in the RolePlanner and the execution logic in the IAMClient.
* **L2-2.2 (Atomic Policy Application):** The manager **must** group the flat list of bindings from the planner into a per-resource policy map before calling the client. This ensures that one atomic ApplyIAMPolicy call is made for each resource.

## **Reinforcement Prompt (Detailed Context)**

**Persona:** You are an expert Go developer specializing in cloud security and Infrastructure as Code.

**Overall Goal:** We are building the core logic for the iam package. We have already defined the data schema, the provider-agnostic IAMClient interface, and the RolePlanner. Now, we need to implement the IAMManager that connects the planner to the client.

**Your Specific Task:** Your task is to generate the complete code for a single Go file: **iam/iammanager.go**. This file will contain the IAMManager struct and its methods. Its primary responsibility is to take the IAM plan, ensure the necessary service accounts exist, and then apply the planned permissions.

**Key Requirements to Fulfill:**

* **Orchestration Logic:** The ApplyIAMForDataflow method should be the main entry point. It must:
    1. Iterate through all services in the specified dataflow and call the IAMClient to ensure their service accounts exist.
    2. Invoke the RolePlanner to get the flat list of required IAMBindings.
    3. **Crucially, assemble this flat list into a map where the key is the unique resource and the value is a PolicyBinding object containing all roles and members for that resource.** This fulfills requirement **L2-2.2**.
    4. Iterate through the assembled map and make a single ApplyIAMPolicy call for each resource.
* **L2-1.1 (Separation of Concerns):** The IAMManager should not contain any logic for *how* to determine roles; it should only consume the plan from the RolePlanner. It should not contain any provider-specific SDK calls; it should only use the IAMClient interface.

**Dependencies (Full source code to be provided):**

1. servicemanager/systemarchitecture.go (contains the full architecture schema)
2. iam/iamadapter.go (contains the IAMClient interface and the PolicyBinding struct)
3. iam/iamplanner.go (contains the RolePlanner that the manager will use)

Output Instructions:  
Generate the complete, well-commented Go code for the iammanager.go file.

* The package name must be iam.
* The IAMManager struct should hold an IAMClient and a RolePlanner.
* The code should be clear and easy to follow, with comments explaining the orchestration steps.